# 組織図アプリケーションの問題と修正点

## 「新規部門追加」機能の問題点

### 問題の症状
- 「新規部署を追加」ボタンをクリックして新しい部署名を追加しても、部署リストに表示されなかった
- コンソールログでは部署データがリストに追加されていたが、UI上には反映されていなかった

### 根本原因
1. **状態管理の問題**:
   - Zustandストアで状態は更新されていたが、Reactコンポーネントの再レンダリングが適切に行われていなかった
   - 同一オブジェクト参照が保持されたため、Reactが変更を検出できなかった

2. **コンポーネント表示の問題**:
   - 部署リストの表示に使用していた `filteredDepartments` が検索フィルター後の結果に依存していた
   - リストアイテムのキーが一意でなかったため、DOM更新が効率的に行われなかった

### 修正内容
1. **状態管理の改善**:
   - useStore.tsの`handleAddDepartment`関数を修正して確実に新しい状態オブジェクトを返すようにした
   - 状態更新後の検証ロジックを追加して、変更が確実に適用されたことを確認

2. **コンポーネントの改良**:
   - レンダリングカウンターを追加して強制的な再レンダリングを実装
   - 部署リスト表示に一意なキーを設定（`dept-${renderCount}-${index}-${dept}`）
   - 検索フィルターに依存せず直接部署リストを表示するように変更

3. **ユーザー要望への対応**:
   - 「新規部署を追加」ボタンでは部署リストにのみ追加されるよう動作を変更
   - 不要なノード自動追加機能を削除

## 教訓
- Reactの状態管理では、オブジェクト参照が変わらないと再レンダリングが発生しない
- 配列やオブジェクトを更新する際は、必ず新しい参照（スプレッド演算子など）を使用する
- コンポーネントの表示リストには常に一意なキーを使用する
- 状態更新後のデバッグ・検証ロジックを組み込むことで問題の早期発見が可能